
module Seri.SMT.Tests.Nest where

import Prelude
import Seri.SMT.Symbolic
import Seri.Tests.Test

qtest :: SMT ()
qtest = do
    r <- nest $ do
        commit $ assert False
        query (return ())
    test "nest.unsat" (r == Nothing)

    a <- commit free
    commit $ (readSMTRef a >>= assert)
    ra <- query $ readSMTRef a
    test "nest.nowsat" (ra == Just True)

    b <- commit free
    c <- commit free
    bc <- commit $ do
            vb <- readSMTRef b
            vc <- readSMTRef c
            assert (vb /= vc)
            return (vb, vc)
    rbc <- query $ readSMTRef bc
    test "nest.prep" $
        case rbc of
            Just (vb, vc) -> vb /= vc
            _ -> False

    rbc1 <- nest $ do
        commit $ (readSMTRef b >>= assert)
        query $ readSMTRef bc
    test "nest.s1" (rbc1 == Just (True, False))

    rbc2 <- nest $ do
        commit $ (readSMTRef c >>= assert)
        query $ readSMTRef bc
    test "nest.s2" (rbc2 == Just (False, True))

    nest $ do
      commit $ do
        x <- free
        assert x
    rd <- query (return ())
    test "nest.popvar" (rd == Just ())
    
main :: IO ()
main = do
    runSMT Yices1 (Just "build/test/Nest.yices1.dbg") qtest
    runSMT Yices2 (Just "build/test/Nest.yices2.dbg") qtest
    runSMT STP (Just "build/test/Nest.stp.dbg") qtest
    putStrLn "NEST PASSED"

