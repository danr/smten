

module Smten.SMT.Tests.QRef where

import Smten.SMT.Symbolic
import Smten.Tests.Test

qtest :: SMT ()
qtest = do
    nest $ do
        xref <- use $ free
        use $ used xref >>= assert
        rx <- query $ used xref
        test "qref.simple" (rx == Just True)

        use $ used xref >>= (assert . not)
        rx2 <- query $ used xref
        test "qref.reuse" (rx2 == Nothing)

    nest $ do
        xref <- use $ free
        use $ do
            v1 <- used xref
            assert v1
            v2 <- used xref
            assert (not v2)
        rx <- query (return ())
        test "qref.dupref" (rx == Nothing)

    nest $ do
        xref <- use $ do
           x <- free
           assert (not x)
           return x
        yref <- use free
        r <- query $ do
            vx <- used xref
            vy <- used yref
            assert (vx || vy)
            return vy
        test "qref.join" (r == Just True)
        
main :: IO ()
main = do
    runSMT Yices1 (Just "build/test/QRef.yices1.dbg") qtest
    runSMT Yices2 (Just "build/test/QRef.yices2.dbg") qtest
    runSMT STP (Just "build/test/QRef.stp.dbg") qtest
    putStrLn "QREF PASSED"
        
